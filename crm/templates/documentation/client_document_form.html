<div class="mt-6">
    <h1 class="font-semibold text-xl mb-5">Upload User's New Document</h1>
    <div class="flex items-center justify-between border rounded-xl bg-white p-6 pb-10">
        <form method="post" class="flex flex-col items-center w-9/12 mt-3 ml-3 gap-2" enctype="multipart/form-data">
            {% csrf_token %}
            <div id="formset-container">
                {{ formset.management_form }}
                {% for form in formset %}
                <div class="form-row">
                    {% if forloop.first %}
                        <!-- Show all fields for the first form -->
                        {% for field in form %}
                            <div class="relative z-0 mb-5 group w-full">
                                <label for="{{ field.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                                    {{ field.label }}
                                </label>                             
                                {{ field|add_class:'block w-full h-14 px-4 py-2 text-gray-400 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                            </div>
                        {% else %}
                            <!-- Show only selected fields with delete option -->
                            <div class="relative z-0 mb-5 group w-full">
                                <label for="{{ form.document_type.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                                    {{ form.document_type.label }}
                                </label>                             
                                {{ form.document_type|add_class:'block w-full h-14 px-4 py-2 text-gray-400 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                            </div>
                            <div class="relative z-0 mb-5 group w-full">
                                <label for="{{ form.document_file.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                                    {{ form.document_file.label }}
                                </label>                             
                                {{ form.document_file|add_class:'block w-full h-14 px-4 py-2 text-gray-400 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                            </div>
                            <button type="button" class="remove-form btn btn-sm btn-danger">❌ Remove</button>
                    {% endif %}
                    <!-- Display field-specific errors -->
                    {% if field.errors %}
                        <p class="text-red-500 text-sm mt-0">{{ field.errors|striptags }}</p>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <input type="submit" value="Submit"
            class="w-full h-16 rounded-md px-7 py-1 bg-[--primary-color] font-normal text-white mt-3" />
        </form>
    </div>
</div>

{% comment %} 
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <div id="formset-container">
        {{ formset.management_form }}

        {% for form in formset %}
            <div class="form-row">
                {% if forloop.first %}
                    <!-- Show all fields for the first form -->
                    {% for field in form %}
                        <div class="form-group">
                            {{ field.label_tag }} {{ field }}
                        </div>
                    {% endfor %}
                {% else %}
                    <!-- Show only selected fields with delete option -->
                    <div class="form-group">
                        {{ form.document_type.label_tag }} {{ form.document_type }}
                    </div>
                    <div class="form-group">
                        {{ form.document_file.label_tag }} {{ form.document_file }}
                    </div>
                    <button type="button" class="remove-form btn btn-sm btn-danger">❌ Remove</button>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <button type="button" id="add-form" class="btn btn-sm btn-primary mt-2">➕ Add Document</button>
    <button type="submit" class="btn btn-success mt-2">Save</button>
</form> {% endcomment %}

<script>
    const addFormBtn = document.getElementById('add-form');
    const formsetContainer = document.getElementById('formset-container');
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');

    addFormBtn.addEventListener('click', function () {
        const formCount = parseInt(totalForms.value);
        const newForm = document.createElement('div');
        newForm.classList.add('form-row');

        const docType = document.getElementById('id_form-0-document_type');
        const docTypeOptions = docType.innerHTML;

        newForm.innerHTML = `
            <div class="relative z-0 mb-5 group w-full">
                <label for="id_form-${formCount}-document_type" class="block mb-3 text-xl font-medium ml-3">Document type:</label>
                <select name="form-${formCount}-document_type" id="id_form-${formCount}-document_type" class="block w-full h-14 px-4 py-2 text-gray-400 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    ${docTypeOptions}
                </select>
            </div>
            <div class="relative z-0 mb-5 group w-full">
                <label for="id_form-${formCount}-document_file" class="block mb-3 text-xl font-medium ml-3">Document file:</label>
                <input type="file" name="form-${formCount}-document_file" class="block w-full h-14 px-4 py-2 text-gray-400 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50" id="id_form-${formCount}-document_file">
            </div>
            <button type="button" class="remove-form btn btn-sm btn-danger">❌ Remove</button>
        `;

        formsetContainer.appendChild(newForm);
        totalForms.value = formCount + 1;
    });

    // Delegate click event to remove buttons
    formsetContainer.addEventListener('click', function (e) {
        if (e.target.classList.contains('remove-form')) {
            e.target.closest('.form-row').remove();
            let forms = formsetContainer.querySelectorAll('.form-row');
            totalForms.value = forms.length;
            // Optional: renumber input names/ids here if necessary
        }
    });
</script>
