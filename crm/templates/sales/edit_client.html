{% extends 'base/base.html' %}
{% load custom_filters %}

{% block head_title %}
Edit Client
{% endblock head_title %}

{% block content %}
<div class="mt-6">
    <h1 class="font-semibold text-2xl mb-5">Edit Client</h1>
    <div class="justify-between border rounded-xl bg-white p-6 pb-10">
        <form method="post" enctype="multipart/form-data" class="flex flex-col w-full mt-3 ml-3 mr-3 gap-2">
            {% csrf_token %}
            <div class="grid md:grid-cols-3 md:gap-6 w-full">
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.name.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.name.label }}
                    </label>                             
                    {{ form.name|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.address.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.address.label }}
                    </label>                             
                    {{ form.address|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.contact_number.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.contact_number.label }}
                    </label>                             
                    {{ form.contact_number|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.email_address.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.email_address.label }}
                    </label>                             
                    {{ form.email_address|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.nationality.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.nationality.label }}
                    </label>                             
                    {{ form.nationality|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.father_name.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.father_name.label }}
                    </label>                             
                    {{ form.father_name|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.mother_name.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.mother_name.label }}
                    </label>                             
                    {{ form.mother_name|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.preferred_country.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.preferred_country.label }}
                    </label>                             
                    {{ form.preferred_country|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.visa_type.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.visa_type.label }}
                    </label>                             
                    {{ form.visa_type|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.package_amount.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.package_amount.label }}
                    </label>                             
                    {{ form.package_amount|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.advance_paid.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.advance_paid.label }}
                    </label>                             
                    {{ form.advance_paid|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
                <div class="relative z-0 mb-5 w-full">
                    <label for="{{ form.due_amount.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                        {{ form.due_amount.label }}
                    </label>                             
                    {{ form.due_amount|add_class:'block w-full h-14 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
                </div>
            </div>
            <div class="relative z-0 mb-5 w-full">
                <label for="{{ form.more_remarks.id_for_label }}" class="block mb-3 text-xl font-medium ml-3">
                    {{ form.more_remarks.label }}
                </label>                             
                {{ form.more_remarks|add_class:'block w-full h-28 px-4 py-2 pl-8 bg-gray-50 border border-gray-300 rounded-md focus:border-(--primary-color) focus:ring focus:ring-blue-200 focus:ring-opacity-50' }}
            </div>
            
            <!--Client Document-->
            <p class="text-2xl font-semibold">More details</p>
            {{ document_formset.management_form }}
            <div class="grid grid-cols-1 md:grid-cols-2 w-full gap-7">
                {% for doc_form in document_formset %}
                    {{ doc_form.id }} 
                    <div class="relative z-0 mb-5 group w-full">
                        <label class="flex gap-2 mb-3">
                            <svg width="24" height="23" viewBox="0 0 24 23" fill="none">
                                <g clip-path="url(#clip0_70_175)">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M1 5.27093C1 4.66864 1.23926 4.09102 1.66514 3.66514C2.09102 3.23926 2.66864 3 3.27093 3H21.4384C22.0407 3 22.6183 3.23926 23.0442 3.66514C23.47 4.09102 23.7093 4.66864 23.7093 5.27093V17.3826C23.7093 17.9848 23.47 18.5625 23.0442 18.9883C22.6183 19.4142 22.0407 19.6535 21.4384 19.6535H3.27093C2.66864 19.6535 2.09102 19.4142 1.66514 18.9883C1.23926 18.5625 1 17.9848 1 17.3826L1 5.27093ZM5.54186 9.05581C5.54186 8.25276 5.86087 7.4826 6.42871 6.91476C6.99656 6.34692 7.76672 6.02791 8.56977 6.02791C9.37282 6.02791 10.143 6.34692 10.7108 6.91476C11.2787 7.4826 11.5977 8.25276 11.5977 9.05581C11.5977 9.85886 11.2787 10.629 10.7108 11.1969C10.143 11.7647 9.37282 12.0837 8.56977 12.0837C7.76672 12.0837 6.99656 11.7647 6.42871 11.1969C5.86087 10.629 5.54186 9.85886 5.54186 9.05581ZM19.1674 9.05581H14.6256V7.54186H19.1674V9.05581ZM19.1674 13.5977H14.6256V12.0837H19.1674V13.5977ZM8.56977 13.5977C7.74681 13.5977 6.94011 13.8268 6.24007 14.2595C5.54002 14.6921 4.97428 15.3112 4.60624 16.0473L4.10663 17.0434C4.04874 17.159 4.02139 17.2874 4.02718 17.4165C4.03296 17.5455 4.0717 17.671 4.13969 17.7809C4.20768 17.8908 4.30267 17.9814 4.4156 18.0442C4.52854 18.107 4.65567 18.1398 4.78488 18.1395H12.3547C12.4837 18.1395 12.6107 18.1065 12.7234 18.0436C12.8361 17.9807 12.9309 17.8901 12.9987 17.7802C13.0665 17.6704 13.1051 17.545 13.1109 17.4161C13.1166 17.2871 13.0892 17.1588 13.0314 17.0434L12.5333 16.0473C12.1653 15.3112 11.5995 14.6921 10.8995 14.2595C10.1994 13.8268 9.39272 13.5977 8.56977 13.5977Z" fill="black"/>
                                </g>
                                <defs>
                                <clipPath id="clip0_70_175">
                                <rect width="22.7093" height="22.7093" fill="white" transform="translate(0.796875)"/>
                                </clipPath>
                                </defs>
                            </svg>
                            Your {{doc_form.instance.document_type}}
                        </label>
                        <div class="relative w-1/2">
                            <div class="absolute inset-y-0 left-48 flex items-center pr-5 pointer-events-none">
                                <svg width="26" height="21" viewBox="0 0 26 21" fill="none">
                                    <path d="M12.6855 18.4001V1.6001" stroke="black" stroke-width="2.52326"/>
                                    <path d="M5.77148 8.2L11.8145 1.90724C12.2961 1.40574 13.0927 1.38842 13.5956 1.8685L20.2286 8.2" stroke="black" stroke-width="2.52326"/>
                                    <path d="M2 9.3999V17.7383C2 18.4351 2.56485 18.9999 3.26163 18.9999H22.7384C23.4352 18.9999 24 18.4351 24 17.7383V9.3999" stroke="black" stroke-width="2.52326"/>
                                </svg>                                 
                            </div>                              
                            {{ doc_form.document|add_class:'block w-full h-14 py-4 pr-2 text-gray-400 text-center border border-gray-400 rounded-xl ' }}
                        </div>

                        <div id="preview{{ forloop.counter }}" class="w-full h-28 flex items-center justify-center rounded-xl border border-gray-400 mt-2">
                            {% if doc_form.instance.document %}
                                <img src="{{ doc_form.instance.document.url }}" alt="Document" class="h-full object-contain" />
                            {% else %}
                                <svg width="41" height="41" viewBox="0 0 41 41" fill="none">
                                    <path d="M24.5981 18.1796C25.3466 18.1796 26.0783 17.9576 26.7007 17.5418C27.3231 17.1259 27.8082 16.5348 28.0946 15.8433C28.3811 15.1517 28.456 14.3908 28.31 13.6566C28.164 12.9225 27.8035 12.2481 27.2742 11.7188C26.7449 11.1896 26.0706 10.8291 25.3364 10.6831C24.6023 10.537 23.8413 10.612 23.1498 10.8984C22.4582 11.1849 21.8672 11.67 21.4513 12.2923C21.0354 12.9147 20.8135 13.6464 20.8135 14.395C20.8135 15.3987 21.2122 16.3613 21.922 17.0711C22.6317 17.7808 23.5943 18.1796 24.5981 18.1796ZM24.5981 13.1334C24.8476 13.1334 25.0915 13.2074 25.299 13.346C25.5064 13.4847 25.6681 13.6817 25.7636 13.9122C25.8591 14.1427 25.8841 14.3964 25.8354 14.6411C25.7867 14.8858 25.6666 15.1106 25.4901 15.287C25.3137 15.4634 25.0889 15.5836 24.8442 15.6323C24.5995 15.6809 24.3458 15.656 24.1153 15.5605C23.8848 15.465 23.6878 15.3033 23.5492 15.0958C23.4105 14.8884 23.3366 14.6445 23.3366 14.395C23.3366 14.0604 23.4695 13.7395 23.706 13.5029C23.9426 13.2663 24.2635 13.1334 24.5981 13.1334Z" fill="black"/>
                                    <path d="M33.4296 5.56396H8.19708C7.52787 5.56396 6.88607 5.82981 6.41287 6.30301C5.93967 6.77621 5.67383 7.41801 5.67383 8.08722V33.3198C5.67383 33.989 5.93967 34.6308 6.41287 35.104C6.88607 35.5772 7.52787 35.843 8.19708 35.843H33.4296C34.0989 35.843 34.7407 35.5772 35.2139 35.104C35.6871 34.6308 35.9529 33.989 35.9529 33.3198V8.08722C35.9529 7.41801 35.6871 6.77621 35.2139 6.30301C34.7407 5.82981 34.0989 5.56396 33.4296 5.56396ZM33.4296 33.3198H8.19708V25.75L14.5052 19.4419L21.5577 26.4944C22.0305 26.9643 22.67 27.2281 23.3366 27.2281C24.0032 27.2281 24.6427 26.9643 25.1155 26.4944L27.1215 24.4884L33.4296 30.7965V33.3198ZM33.4296 27.2261L28.9004 22.6969C28.4276 22.2269 27.7881 21.9631 27.1215 21.9631C26.4549 21.9631 25.8154 22.2269 25.3426 22.6969L23.3366 24.7029L16.2841 17.6504C15.8114 17.1804 15.1718 16.9166 14.5052 16.9166C13.8386 16.9166 13.1991 17.1804 12.7263 17.6504L8.19708 22.1796V8.08722H33.4296V27.2261Z" fill="black"/>
                                </svg>  
                            {% endif %}                                                             
                        </div>
                    </div>
                {% endfor %}
            </div>

            <input type="submit" value="Update"
            class="w-10/12 h-16 rounded-md px-7 py-1 bg-[--primary-color] font-normal text-white mt-3 ml-16" />
        </form>
    </div>
</div>

<script>
    document.querySelectorAll('input[type="file"]').forEach((input, index) => {
      input.addEventListener('change', function() {
        const previewId = 'preview' + (index + 1);
        const preview = document.getElementById(previewId);
        preview.innerHTML = '';
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'w-auto h-28 border rounded shadow';
            preview.appendChild(img);
          };
          reader.readAsDataURL(this.files[0]);
        }
      });
    });


    document.addEventListener("DOMContentLoaded", function () {
        const packageAmountInput = document.getElementById("id_package_amount");
        const advancePaidInput = document.getElementById("id_advance_paid");
        const dueAmountInput = document.getElementById("id_due_amount");

        function updateDueAmount() {
            const packageAmount = parseFloat(packageAmountInput.value) || 0;
            const advancePaid = parseFloat(advancePaidInput.value) || 0;
            const dueAmount = packageAmount - advancePaid;
            dueAmountInput.value = dueAmount.toFixed(2);  // keep 2 decimals
        }

        packageAmountInput.addEventListener("input", updateDueAmount);
        advancePaidInput.addEventListener("input", updateDueAmount);

        // Initial update
        updateDueAmount();
    });
    
</script>
  
{% endblock content %}